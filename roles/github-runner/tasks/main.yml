---
- name: Create runner working directory
  file:
    path: "{{ runner_workdir }}"
    state: directory
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'

- name: Check if runner already exists
  stat:
    path: "{{ runner_workdir }}/github-act-runner"
  register: runner_binary

- name: Clone github-act-runner repository
  git:
    repo: 'https://github.com/ChristopherHX/github-act-runner.git'
    dest: "{{ runner_workdir }}"
    version: "{{ runner_version }}"
    force: yes
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists

- name: Build github-act-runner
  command: go build -o github-act-runner
  args:
    chdir: "{{ runner_workdir }}"
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists
  register: build_result

# Note: This project uses github-act-runner (ChristopherHX's fork) which is compatible with RISC-V64.
# Unlike the official GitHub Actions runner which uses '.runner' as its configuration file,
# github-act-runner stores its configuration in 'settings.json' after running 'configure'.
- name: Check if runner is already configured
  stat:
    path: "{{ runner_workdir }}/settings.json"
  register: runner_config

- name: Configure runner (if not already configured)
  command: >
    {{ runner_workdir }}/github-act-runner configure
    --url https://github.com/{{ github_repository }}
    --pat {{ github_pat }}
    --name {{ runner_name }}
    --labels self-hosted,linux,riscv64
    --work _work
    --unattended
  args:
    chdir: "{{ runner_workdir }}"
  become_user: "{{ runner_user }}"
  environment:
    HOME: "/home/{{ runner_user }}"
  when: github_pat != '' and not runner_config.stat.exists
  no_log: true
  register: configure_result
  failed_when: configure_result.rc != 0 and 'already configured' not in configure_result.stderr

- name: Display configuration result (without secrets)
  debug:
    msg: "Runner configuration completed with return code: {{ configure_result.rc | default('skipped') }}"
  when: configure_result is defined and configure_result.rc is defined

- name: Create systemd service file
  template:
    src: github-runner.service.j2
    dest: /etc/systemd/system/github-runner.service
    mode: '0644'
  notify: restart github-runner

- name: Enable and start github-runner service
  systemd:
    name: github-runner
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for runner to be ready
  pause:
    seconds: 10

- name: Check runner service status
  systemd:
    name: github-runner
    state: started
  register: runner_status

- name: Display runner status
  debug:
    msg: "GitHub Runner service is {{ runner_status.status.ActiveState }}"

# Verification tasks to ensure runner reliability after reboots
# See docs/RUNNER-RELIABILITY-FIXES.md for background
- name: Verify runner service is enabled for auto-start
  systemd:
    name: github-runner
  register: runner_service_status
  failed_when: runner_service_status.status.UnitFileState != 'enabled'

- name: Verify runner service is currently active
  systemd:
    name: github-runner
  register: runner_service_active
  until: runner_service_active.status.ActiveState == 'active'
  retries: 3
  delay: 5
  failed_when: runner_service_active.status.ActiveState != 'active'

# Weekly auto-update for github-act-runner
- name: Deploy runner update script
  template:
    src: update-runner.sh.j2
    dest: "{{ runner_workdir }}/update-runner.sh"
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'

- name: Create log file for runner updates
  file:
    path: /var/log/github-runner-update.log
    state: touch
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0644'
  changed_when: false

- name: Configure passwordless sudo for runner user
  copy:
    content: |
      # Allow {{ runner_user }} passwordless sudo for CI/CD operations
      # Scoped to specific commands for security (not ALL)
      # See docs/RUNNER-RELIABILITY-FIXES.md for security considerations
      {{ runner_user }} ALL=(ALL) NOPASSWD: /usr/bin/apt-get, /usr/bin/apt, /usr/bin/dpkg, /usr/bin/systemctl, /usr/bin/docker, /usr/bin/tee, /usr/bin/mkdir, /usr/bin/chmod, /usr/bin/chown
    dest: /etc/sudoers.d/{{ runner_user }}-nopasswd
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Remove old limited sudoers file (if exists)
  file:
    path: /etc/sudoers.d/github-runner-update
    state: absent

- name: Verify passwordless sudo is working
  command: sudo -n true
  become: true
  become_user: "{{ runner_user }}"
  changed_when: false
  register: sudo_check
  failed_when: sudo_check.rc != 0

- name: Setup weekly cron job for runner updates
  cron:
    name: "Weekly github-act-runner update"
    user: "{{ runner_user }}"
    weekday: "0"
    hour: "3"
    minute: "0"
    job: "{{ runner_workdir }}/update-runner.sh >> /var/log/github-runner-update.log 2>&1"
    state: "{{ 'present' if runner_auto_update | default(true) | bool else 'absent' }}"
