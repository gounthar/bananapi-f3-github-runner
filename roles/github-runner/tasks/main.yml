---
- name: Create runner working directory
  file:
    path: "{{ runner_workdir }}"
    state: directory
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'

- name: Check if runner already exists
  stat:
    path: "{{ runner_workdir }}/github-act-runner"
  register: runner_binary

- name: Clone github-act-runner repository
  git:
    repo: 'https://github.com/ChristopherHX/github-act-runner.git'
    dest: "{{ runner_workdir }}/src"
    version: "{{ runner_version }}"
    force: yes
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists

- name: Build github-act-runner
  command: go build -o github-act-runner
  args:
    chdir: "{{ runner_workdir }}/src"
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists
  register: build_result

- name: Copy binary to working directory
  copy:
    src: "{{ runner_workdir }}/src/github-act-runner"
    dest: "{{ runner_workdir }}/github-act-runner"
    remote_src: yes
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'
  when: not runner_binary.stat.exists

# Note: This project uses github-act-runner (ChristopherHX's fork) which is compatible with RISC-V64.
# Unlike the official GitHub Actions runner which uses '.runner' as its configuration file,
# github-act-runner stores its configuration in 'settings.json' after running 'configure'.
- name: Check if runner is already configured
  stat:
    path: "{{ runner_workdir }}/settings.json"
  register: runner_config

- name: Configure runner (if not already configured)
  command: >
    {{ runner_workdir }}/github-act-runner configure
    --url https://github.com/{{ github_repository }}
    --pat {{ github_pat }}
    --name {{ runner_name }}
    --labels self-hosted,linux,riscv64
    --work _work
    --unattended
  args:
    chdir: "{{ runner_workdir }}"
  become_user: "{{ runner_user }}"
  environment:
    HOME: "/home/{{ runner_user }}"
  when: github_pat != '' and not runner_config.stat.exists
  no_log: true
  register: configure_result
  ignore_errors: yes

- name: Display configuration result (without secrets)
  debug:
    msg: "Runner configuration completed with return code: {{ configure_result.rc | default('skipped') }}"
  when: configure_result is defined and configure_result.rc is defined

- name: Create systemd service file
  template:
    src: github-runner.service.j2
    dest: /etc/systemd/system/github-runner.service
    mode: '0644'
  notify: restart github-runner

- name: Enable and start github-runner service
  systemd:
    name: github-runner
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for runner to be ready
  pause:
    seconds: 10

- name: Check runner service status
  systemd:
    name: github-runner
    state: started
  register: runner_status

- name: Display runner status
  debug:
    msg: "GitHub Runner service is {{ runner_status.status.ActiveState }}"
