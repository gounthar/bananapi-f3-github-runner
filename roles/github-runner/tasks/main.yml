---
- name: Create runner working directory
  file:
    path: "{{ runner_workdir }}"
    state: directory
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'

- name: Check if runner already exists
  stat:
    path: "{{ runner_workdir }}/github-act-runner"
  register: runner_binary

- name: Clone github-act-runner repository
  git:
    repo: 'https://github.com/ChristopherHX/github-act-runner.git'
    dest: "{{ runner_workdir }}/src"
    version: "{{ runner_version }}"
    force: yes
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists

- name: Build github-act-runner
  command: go build -o github-act-runner
  args:
    chdir: "{{ runner_workdir }}/src"
  become_user: "{{ runner_user }}"
  when: not runner_binary.stat.exists
  register: build_result

- name: Copy binary to working directory
  copy:
    src: "{{ runner_workdir }}/src/github-act-runner"
    dest: "{{ runner_workdir }}/github-act-runner"
    remote_src: yes
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'
  when: not runner_binary.stat.exists

- name: Create runner settings from template
  template:
    src: settings.json.j2
    dest: "{{ runner_workdir }}/settings.json"
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0600'
  when: github_pat != ''
  no_log: true

- name: Configure runner (if not already configured)
  command: >
    {{ runner_workdir }}/github-act-runner configure
    --url {{ github_repository }}
    --token {{ github_pat }}
    --name {{ runner_name }}
    --labels self-hosted,linux,riscv64
    --work _work
  args:
    chdir: "{{ runner_workdir }}"
  become_user: "{{ runner_user }}"
  environment:
    HOME: "/home/{{ runner_user }}"
  when: >
    github_pat != '' and
    (not runner_binary.stat.exists or
     (settings_check.stat.exists is defined and not settings_check.stat.exists))
  no_log: true
  register: configure_result
  failed_when: configure_result.rc != 0 and 'already configured' not in configure_result.stderr

- name: Create systemd service file
  template:
    src: github-runner.service.j2
    dest: /etc/systemd/system/github-runner.service
    mode: '0644'
  notify: restart github-runner

- name: Enable and start github-runner service
  systemd:
    name: github-runner
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for runner to be ready
  pause:
    seconds: 10

- name: Check runner service status
  systemd:
    name: github-runner
    state: started
  register: runner_status

- name: Display runner status
  debug:
    msg: "GitHub Runner service is {{ runner_status.status.ActiveState }}"
