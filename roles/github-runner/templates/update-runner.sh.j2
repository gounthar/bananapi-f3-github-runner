#!/bin/bash
#
# Weekly update script for github-act-runner
# This script pulls the latest code, rebuilds the binary, and restarts the service
#
# Deployed by Ansible - do not edit manually
#

set -e

RUNNER_DIR="{{ runner_workdir }}"
SRC_DIR="${RUNNER_DIR}/src"
LOG_FILE="/var/log/github-runner-update.log"
LOCK_DIR="${RUNNER_DIR}/.update.lock"

# Logging function (write directly to file, no tee to avoid double logging with cron redirect)
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

# Atomic lock acquisition using mkdir (atomic on POSIX systems)
if ! mkdir "$LOCK_DIR" 2>/dev/null; then
    log "ERROR: Another update is already running (lock directory exists)"
    exit 1
fi

# Cleanup lock on exit (use single quotes for proper variable expansion at trap execution time)
trap 'rm -rf "$LOCK_DIR"' EXIT

log "Starting github-act-runner update check..."

cd "$SRC_DIR" || { log "ERROR: Cannot access source directory $SRC_DIR"; exit 1; }

# Get current commit
CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
log "Current commit: $CURRENT_COMMIT"

# Fetch latest changes
log "Fetching latest changes from origin..."
if ! git fetch origin {{ runner_version | default('main') }}; then
    log "ERROR: Failed to fetch from origin"
    exit 1
fi

# Get remote commit
REMOTE_COMMIT=$(git rev-parse origin/{{ runner_version | default('main') }} 2>/dev/null || echo "unknown")
log "Remote commit: $REMOTE_COMMIT"

# Check if update is needed
if [ "$CURRENT_COMMIT" = "$REMOTE_COMMIT" ]; then
    log "Already up to date. No rebuild needed."
    exit 0
fi

log "New version available. Updating..."

# Pull latest changes
if ! git pull origin {{ runner_version | default('main') }}; then
    log "ERROR: Failed to pull from origin"
    exit 1
fi

# Build new binary
log "Building new github-act-runner binary..."
if ! go build -o github-act-runner; then
    log "ERROR: Build failed"
    exit 1
fi

# Verify binary exists and is executable
if [ ! -x github-act-runner ]; then
    log "ERROR: Built binary github-act-runner not found or not executable"
    exit 1
fi

# Copy to working directory
log "Installing new binary..."
# Backup the old binary before overwriting
if [ -f "${RUNNER_DIR}/github-act-runner" ]; then
    cp "${RUNNER_DIR}/github-act-runner" "${RUNNER_DIR}/github-act-runner.backup"
fi
cp github-act-runner "${RUNNER_DIR}/"

# Restart the service
log "Restarting github-runner service..."
sudo systemctl restart github-runner

# Wait up to 15 seconds for the service to become active
SERVICE_STARTED=false
for i in {1..15}; do
    if systemctl is-active --quiet github-runner; then
        SERVICE_STARTED=true
        log "Update complete. Service is running."
        NEW_COMMIT=$(git rev-parse HEAD)
        log "Updated from $CURRENT_COMMIT to $NEW_COMMIT"
        break
    fi
    sleep 1
done

# Final check after timeout
if [ "$SERVICE_STARTED" = false ]; then
    log "ERROR: Service failed to start after update!"
    exit 1
fi
